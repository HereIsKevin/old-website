---
import { getEntry } from "astro:content"

import HeroPage from "../layouts/HeroPage.astro"

const entry = await getEntry("egg", "game")
const data = entry.data
---

<HeroPage title="Easter Egg | Kevin" image='url("/voronoi.svg")'>
  <Fragment slot="hero">
    <div id="game" hidden>
      <div id="prompt">
        <button id="submit">&gt;</button>
        <input id="input" type="text" />
      </div>
      <template id="template">
        <div class="display">
          <h2 class="heading"></h2>
          <p class="message"></p>
        </div>
      </template>
    </div>
    <div id="message">
      <h1 class="title">ðŸ¥š Not Found</h1>
      <p class="description">
        Nothing interesting here, at least for now. Also, be sure to check out
        the 404 Not Found page, it's awesome.
      </p>
    </div>
  </Fragment>
</HeroPage>

<style>
  #game {
    width: 100%;
    margin-top: 60px;
    height: calc(100dvh - 110px);

    background-color: var(--color-primary-transparent);
    backdrop-filter: blur(3px);
    border-width: 1px;
    border-style: solid;
    border-color: var(--color-white);
    border-radius: 5px;
    overflow: scroll;
  }

  .title {
    margin: 0;
    font-size: var(--size-large);
  }

  .description {
    margin: 0;
    font-size: var(--size-medium);
    line-height: calc(var(--size-medium) + 10px);
  }
</style>

<script define:vars={{ data }}>
  window.data = data
</script>

<script>
  import type { CollectionEntry } from "astro:content"

  type Data = CollectionEntry<"egg">["data"]

  declare global {
    var data: Data
  }

  let query: ((action: string) => void) | undefined

  const prompt = document.getElementById("prompt")!
  const submit = document.getElementById("submit") as HTMLButtonElement
  const input = document.getElementById("input") as HTMLInputElement
  const template = document.getElementById("template") as HTMLTemplateElement

  submit.addEventListener("click", () => {
    if (query === undefined) {
      return
    }

    const value = input.value.trim().toLowerCase()
    input.value = ""
    query(value)
  })

  prompt.addEventListener("keypress", (event) => {
    if (query === undefined || event.key !== "Enter") {
      return
    }

    const value = input.value.trim().toLowerCase()
    input.value = ""
    query(value)
  })

  function sleep(ms: number): Promise<void> {
    return new Promise((resolve) => setTimeout(resolve, ms))
  }

  function error(): void {
    const fragment = template.content.cloneNode(true) as DocumentFragment
    const displayElement = fragment.firstElementChild!
    const headingElement = displayElement.firstElementChild!
    const messageElement = displayElement.lastElementChild!

    headingElement.remove()
    messageElement.textContent = "Please try again..."
    prompt.before(displayElement)
  }

  function end(): void {
    const fragment = template.content.cloneNode(true) as DocumentFragment
    const displayElement = fragment.firstElementChild!
    const headingElement = displayElement.firstElementChild!
    const messageElement = displayElement.lastElementChild!

    headingElement.textContent = "The End"
    messageElement.remove()
    prompt.before(displayElement)

    input.disabled = true
    submit.disabled = true
  }

  async function display(heading: string, message: string): Promise<void> {
    input.disabled = true
    submit.disabled = true

    const fragment = template.content.cloneNode(true) as DocumentFragment
    const displayElement = fragment.firstElementChild!
    const headingElement = displayElement.firstElementChild!
    const messageElement = displayElement.lastElementChild!

    headingElement.textContent = heading
    prompt.before(displayElement)

    for (const character of message) {
      messageElement.textContent += character
      await sleep(1)
    }

    input.disabled = false
    submit.disabled = false

    input.focus()
  }

  class Room {
    #game: Game
    #heading: string
    #message: string
    #actionOrActions: string | Record<string, string>

    constructor(
      game: Game,
      heading: string,
      message: string,
      actionOrActions: string | Record<string, string>
    ) {
      this.#game = game
      this.#heading = heading
      this.#message = message
      this.#actionOrActions = actionOrActions
    }

    #query = (action: string): void => {
      if (typeof this.#actionOrActions === "string") {
        throw Error("Missing 'actions' for querying")
      }

      const room = this.#actionOrActions[action]

      if (room === undefined) {
        error()
        return
      }

      this.#game.move(room)
    }

    async run(): Promise<void> {
      await display(this.#heading, this.#message)

      if (typeof this.#actionOrActions === "string") {
        this.#game.move(this.#actionOrActions)
      } else {
        query = this.#query
      }
    }
  }

  class Game {
    #room: string
    #rooms: Record<string, Room> = {}

    constructor(data: Data) {
      this.#room = data.config.room

      for (const [name, room] of Object.entries(data.rooms)) {
        const { heading, message, action, actions } = room

        if (action !== undefined && actions === undefined) {
          this.#rooms[name] = new Room(this, heading, message, action)
        } else if (action === undefined && actions !== undefined) {
          this.#rooms[name] = new Room(this, heading, message, actions)
        } else {
          throw new Error("One of 'action' or 'actions' must exist.")
        }
      }
    }

    move(room: string): void {
      if (room === "end") {
        end()
        return
      }

      const currentRoom = this.#rooms[room]

      if (currentRoom === undefined) {
        throw new Error(`Room '${room}' does not exist.`)
      }

      currentRoom.run()
      this.#room = room
    }

    run(): void {
      this.move(this.#room)
    }
  }

  const game = document.getElementById("game")!
  const message = document.getElementById("message")!

  if (window.localStorage.getItem("egg") === "enabled") {
    game.hidden = false
    message.hidden = true

    new Game(window.data).run()
  }
</script>
